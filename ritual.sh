#!/bin/bash

# –õ–æ–≥–æ—Ç–∏–ø
while true; do
  echo -e '\e[40m\e[32m'
  echo -e '‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó '
  echo -e '‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó'
  echo -e '‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù'
  echo -e '‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó'
  echo -e '‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë'
  echo -e '‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù'
  echo -e '\e[0m'

  echo -e "\n–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª may.crypto{ü¶Ö} —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ —Å–∞–º—ã—Ö –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–æ–¥ - https://t.me/maycrypto\n"
  
  sleep 2
  break
done

# –¶–≤–µ—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
fmt=$(tput setaf 45)
end="\e[0m\n"
err="\e[31m"
scss="\e[32m"
log_file="/var/log/script.log"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if [ "$EUID" -ne 0 ]; then
  echo -e "${err}–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ root${end}" | tee -a "$log_file"
  exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—à–∏–±–æ–∫
check_error() {
  if [ $? -ne 0 ]; then
    echo -e "${err}$1${end}" | tee -a "$log_file"
    exit 1
  fi
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
installation() {
  if [ -z "$RPC_URL" ]; then
    echo -e "${err}\n–í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ RPC_URL, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞${end}" | tee -a "$log_file"
    exit 1
  fi

  if [ -z "$PRIVATE_KEY" ]; then
    echo -e "${err}\n–í—ã –Ω–µ —É–∫–∞–∑–∞–ª–∏ PRIVATE_KEY${end}" | tee -a "$log_file"
    exit 1
  fi

  if [[ "${PRIVATE_KEY:0:2}" != "0x" ]]; then
    PRIVATE_KEY="0x${PRIVATE_KEY}"
    echo -e "${fmt}Private Key –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª '0x' –≤ –Ω–∞—á–∞–ª–µ. –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.${end}" | tee -a "$log_file"
  fi

  echo -e "${fmt}\n–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π${end}" | tee -a "$log_file"
  sudo apt update && sudo apt upgrade -y
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã"

  sudo apt -qy install curl git jq lz4 build-essential make
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã"

  if ! command -v docker &> /dev/null || ! command -v docker-compose &> /dev/null; then
    sudo wget https://raw.githubusercontent.com/fackNode/requirements/main/docker.sh -O /tmp/docker.sh
    check_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker"
    chmod +x /tmp/docker.sh && /tmp/docker.sh
    check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker"
  fi

  git clone --recurse-submodules https://github.com/ritual-net/infernet-container-starter /root/infernet-container-starter
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"

  echo -e "${fmt}\n–°–æ–∑–¥–∞–Ω–∏–µ deploy-container.service${end}" | tee -a "$log_file"

  sudo tee /etc/systemd/system/deploy-container.service <<EOF
[Unit]
Description=Deploy Container Service
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'cd /root/infernet-container-starter && project=hello-world make deploy-container'
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

  sudo systemctl daemon-reload
  sudo systemctl enable deploy-container
  sudo systemctl start deploy-container
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É deploy-container"

  echo -e "${fmt}\n–û–∂–∏–¥–∞–Ω–∏–µ 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ Docker${end}" | tee -a "$log_file"
  sleep 60

  if docker ps -a | grep -q 'deploy-redis-1' && docker ps -a | grep -q 'deploy-fluentbit-1'; then
    echo -e "${scss}\n–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã${end}" | tee -a "$log_file"
  else
    echo -e "${err}\n–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ...${end}" | tee -a "$log_file"
  fi

  echo -e "${fmt}\n–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Makefile${end}" | tee -a "$log_file"
  
  CONFIG_FILE=~/infernet-container-starter/projects/hello-world/container/config.json
  sed -i "9s|\"rpc_url\": \".*\"|\"rpc_url\": \"$RPC_URL\"|" $CONFIG_FILE
  sed -i "13s|\"private_key\": \".*\"|\"private_key\": \"$PRIVATE_KEY\"|" $CONFIG_FILE
  sed -i 's/sender := .*/sender := '"$PRIVATE_KEY"'/' /root/infernet-container-starter/projects/hello-world/contracts/Makefile
  sed -i 's|RPC_URL := .*|RPC_URL := '"$RPC_URL"'|' /root/infernet-container-starter/projects/hello-world/contracts/Makefile

  echo -e "${fmt}\n–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Deploy.s.sol${end}" | tee -a "$log_file"
  sed -i 's/address coordinator = 0x5FbDB2315678afecb367f032d93F642f64180aa3;/address coordinator = 0x8D871Ef2826ac9001fB2e33fDD6379b6aaBF449c;/' /root/infernet-container-starter/projects/hello-world/contracts/script/Deploy.s.sol

  echo -e "${fmt}\n–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ Docker –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫${end}" | tee -a "$log_file"
  for container in hello-world deploy-fluentbit-1 deploy-redis-1; do
    docker restart $container
    check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä $container"
  done

  echo -e "${fmt}\n–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Foundry${end}" | tee -a "$log_file"
  cd /root/

  mkdir -p foundry
  cd foundry

  curl -L https://foundry.paradigm.xyz | bash
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Foundry"

  ~/.foundry/bin/foundryup
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Foundry"
}

# –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–¥—ã
node_tune() {
  echo -e "${fmt}‚öíÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–æ–¥—ã! ‚öíÔ∏è${end}" | tee -a "$log_file"
  CONTRACT_DATA_FILE="/root/infernet-container-starter/projects/hello-world/contracts/broadcast/Deploy.s.sol/8453/run-latest.json"
  CONFIG_FILE="/root/infernet-container-starter/deploy/config.json"
  CONTRACT_ADDRESS=$(jq -r '.receipts[0].contractAddress' "$CONTRACT_DATA_FILE")

  if [ -z "$CONTRACT_ADDRESS" ]; then
    echo -e "${err}–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å contractAddress –∏–∑ $CONTRACT_DATA_FILE${end}" | tee -a "$log_file"
    exit 1
  fi

  echo -e "${fmt}–ê–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞: $CONTRACT_ADDRESS${end}" | tee -a "$log_file"

  if grep -qF "$CONTRACT_ADDRESS" "$CONFIG_FILE"; then
    echo "$CONTRACT_ADDRESS —É–∂–µ –≤ –º–∞—Å—Å–∏–≤–µ allowed_addresses" | tee -a "$log_file"
    exit 0
  fi

  echo -e "${fmt}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ snapshot_sync –≤ /root/infernet-container-starter/deploy/config.json${end}" | tee -a "$log_file"
  jq '. += { "snapshot_sync": { "sleep": 5, "batch_size": 25 } }' "$CONFIG_FILE" > temp.json && mv temp.json "$CONFIG_FILE"

  echo -e "${fmt}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ $CONTRACT_ADDRESS –≤ allowed_addresses –≤ /root/infernet-container-starter/deploy/config.json${end}" | tee -a "$log_file"
  jq --arg contract_address "$CONTRACT_ADDRESS" '.containers[] |= if .id == "hello-world" then .allowed_addresses += [$contract_address] else . end' "$CONFIG_FILE" > temp.json && mv temp.json "$CONFIG_FILE"

  cat "$CONFIG_FILE" | tee -a "$log_file"

  docker restart deploy-node-1
  check_error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å deploy-node-1"
}

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –Ω–æ–¥—ã
view_logs() {
  echo -e "${fmt}–ß–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥ –Ω–∞—á–Ω–µ—Ç—Å—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–≥–æ–≤... –î–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–æ–≥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é CTRL+C${end}"
  sleep 15
  docker ps
  CONTAINER_ID=$(docker ps --filter "name=infernet-anvil" --format "{{.ID}}")
  if [ -z "$CONTAINER_ID" ]; then
    echo -e "${err}–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä infernet-anvil –Ω–µ –Ω–∞–π–¥–µ–Ω${end}" | tee -a "$log_file"
    exit 1
  fi
  docker logs -f "$CONTAINER_ID"
}

# –ú–µ–Ω—é
PS3='–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é: '
options=("–í–≤–µ—Å—Ç–∏ RPC —Å—Å—ã–ª–∫—É" "–í–≤–µ—Å—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á" "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É Ritual" "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –Ω–æ–¥—ã Ritual" "–í—ã–π—Ç–∏ –∏–∑ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞")
select opt in "${options[@]}"
do
  case $opt in
    "–í–≤–µ—Å—Ç–∏ RPC —Å—Å—ã–ª–∫—É")
      read -p "–í–≤–µ–¥–∏—Ç–µ RPC URL: " RPC_URL
      export RPC_URL
      ;;
    "–í–≤–µ—Å—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á")
      read -p "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á: " PRIVATE_KEY
      if [[ "${PRIVATE_KEY:0:2}" != "0x" ]]; then
        PRIVATE_KEY="0x${PRIVATE_KEY}"
        echo -e "${fmt}Private Key –Ω–µ —Å–æ–¥–µ—Ä–∂–∞–ª '0x' –≤ –Ω–∞—á–∞–ª–µ. –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.${end}"
      fi
      export PRIVATE_KEY
      ;;
    "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–¥—É Ritual")
      installation
      ;;
    "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –Ω–æ–¥—ã Ritual")
      view_logs
      ;;
    "–í—ã–π—Ç–∏ –∏–∑ —É—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞")
      break
      ;;
    *) echo "–ù–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è $REPLY";;
  esac
done
